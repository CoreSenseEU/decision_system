<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4">
  <!-- Decide Meta -->
  <BehaviorTree ID="MakeSureGapClosed">
    <!-- TODO: 
      When assembling the main tree for this gap:
        - remap {choice_query} to {return_message}
        - remap {gap} to {payload}
        - copy each subtree into the same file
        - fill in all the action names
        - set the {@prolog_query} service name in the global blackboard
    -->
    <Fallback>
      <!-- Check if this gap has already been closed -->
      <PrologFetchFromGap gap="{gap}" 
                          query="closed_with(_G, _T)" 
                          target="{choice_query}" 
                          maxresult="1"
                          service_name="{@prolog_query}" />

      <Sequence>
        <RetryUntilSuccessful _while="!aborted" num_attempts="20">
          <!-- Make sure done -->
          <Sequence> 
            <SubTree ID="MakeSureChoiceTaken" _autoremap="true" />
            <SubTree ID="MakeSureChoiceAccepted" _autoremap="true" />
          </Sequence>
        </RetryUntilSucccessful>
        <CloseGap _failureIf="aborted | !accepted" 
                  gap="{gap}"
                  choice="{choice}" 
                  handle="{choice_query}"
                  action_name="" />
      </Sequence>
    </Fallback>
  </BehaviorTree>
</root>
